name: Spring Boot Build & Push

on:
  workflow_call:
    inputs:
      java-version:
        type: string
        default: '17'
        description: 'Java version'
      environment:
        type: string
        required: true
        description: 'Environment (dev, pro, etc.)'
      project-name:
        type: string
        required: true
        description: 'Project name for Docker image'
      application-name:
        type: string
        default: 'api'
        description: 'Application name'
      docker-hub-username:
        type: string
        required: true
        description: 'Docker Hub username'
      keep-images:
        type: number
        default: 4
        description: 'Number of recent images to keep'
    outputs:
      image-tag:
        description: 'Built Docker image tag'
        value: ${{ jobs.build.outputs.image-tag }}
    secrets:
      DOCKER_HUB_ACCESS_TOKEN:
        required: true
      # ÌÇ§ ÌååÏùºÎì§ (optional)
      FIREBASE_KEY_BASE64:
        required: false
      APP_STORE_KEY_BASE64:
        required: false
      IAP_PAYMENT_KEY_BASE64:
        required: false

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.set_outputs.outputs.image_tag }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.environment }}

      - name: Set up JDK ${{ inputs.java-version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java-version }}
          distribution: 'temurin'

      - name: Restore key files (if provided)
        run: |
          if [ -n "${{ secrets.FIREBASE_KEY_BASE64 }}" ] || \
             [ -n "${{ secrets.APP_STORE_KEY_BASE64 }}" ] || \
             [ -n "${{ secrets.IAP_PAYMENT_KEY_BASE64 }}" ]; then
            
            mkdir -p src/main/resources/key-store
            
            if [ -n "${{ secrets.FIREBASE_KEY_BASE64 }}" ]; then
              echo "${{ secrets.FIREBASE_KEY_BASE64 }}" | base64 -d > src/main/resources/key-store/${{ inputs.project-name }}-firebase-key.json
              echo "‚úÖ Firebase key restored"
            fi
            
            if [ -n "${{ secrets.APP_STORE_KEY_BASE64 }}" ]; then
              echo "${{ secrets.APP_STORE_KEY_BASE64 }}" | base64 -d > src/main/resources/key-store/${{ inputs.project-name }}-app-store-key.p8
              echo "‚úÖ App Store key restored"
            fi
            
            if [ -n "${{ secrets.IAP_PAYMENT_KEY_BASE64 }}" ]; then
              echo "${{ secrets.IAP_PAYMENT_KEY_BASE64 }}" | base64 -d > src/main/resources/key-store/${{ inputs.project-name }}-iap-payment-key.json
              echo "‚úÖ IAP Payment key restored"
            fi
          else
            echo "‚ÑπÔ∏è No key files to restore"
          fi

      - name: Grant execute permission
        run: chmod +x gradlew

      - name: Build application
        run: ./gradlew clean build -x test

      - name: Set image tags
        run: |
          DATE_TAG=$(date +'%Y.%m.%d')
          DATED_TAG="${{ inputs.docker-hub-username }}/${{ inputs.project-name }}-${{ inputs.application-name }}:${{ inputs.environment }}.$DATE_TAG.${{ github.run_number }}"
          
          echo "DATED_TAG=$DATED_TAG" >> $GITHUB_ENV
          echo "üî® Building Docker image: $DATED_TAG"
          
          docker build -t $DATED_TAG .

      - name: Set outputs
        id: set_outputs
        run: echo "image_tag=${{ env.DATED_TAG }}" >> $GITHUB_OUTPUT

      - name: Docker Hub Login
        uses: docker/login-action@v3
        with:
          username: ${{ inputs.docker-hub-username }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      - name: Push to Docker Hub
        run: |
          echo "üì§ Pushing Docker image..."
          docker push ${{ env.DATED_TAG }}
          echo "‚úÖ Push completed: ${{ env.DATED_TAG }}"

      - name: Cleanup old images
        run: |
          echo "üßπ Cleaning up old images..."
          
          TOKEN=$(curl -s -H "Content-Type: application/json" -X POST \
            -d "{\"username\": \"${{ inputs.docker-hub-username }}\", \"password\": \"${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}\"}" \
            https://hub.docker.com/v2/users/login/ | jq -r .token)
          
          if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
            echo "‚ö†Ô∏è Failed to get Docker Hub token, skipping cleanup"
            exit 0
          fi
          
          # Fetch all tags
          PAGE=1
          ALL_TAGS=""
          
          while true; do
            RESPONSE=$(curl -s -H "Authorization: JWT $TOKEN" \
              "https://hub.docker.com/v2/repositories/${{ inputs.docker-hub-username }}/${{ inputs.project-name }}-${{ inputs.application-name }}/tags/?page=$PAGE&page_size=100")
            
            PAGE_TAGS=$(echo "$RESPONSE" | jq -r ".results[] | select(.name | startswith(\"${{ inputs.environment }}.\")) | .name")
            
            if [ -z "$PAGE_TAGS" ]; then
              break
            fi
            
            ALL_TAGS="$ALL_TAGS $PAGE_TAGS"
            
            HAS_NEXT=$(echo "$RESPONSE" | jq -r '.next')
            if [ "$HAS_NEXT" == "null" ]; then
              break
            fi
            
            PAGE=$((PAGE+1))
          done
          
          # Sort by run number and keep recent ones
          SORTED_TAGS=$(echo $ALL_TAGS | tr ' ' '\n' | grep "^${{ inputs.environment }}\." | sort -t'.' -k4 -nr)
          TAGS_TO_DELETE=$(echo "$SORTED_TAGS" | tail -n +$((inputs.keep-images + 1)))
          
          if [ -n "$TAGS_TO_DELETE" ]; then
            echo "üóëÔ∏è Deleting old tags..."
            echo "$TAGS_TO_DELETE" | while read -r TAG; do
              if [ -n "$TAG" ]; then
                curl -s -X DELETE -H "Authorization: JWT $TOKEN" \
                  "https://hub.docker.com/v2/repositories/${{ inputs.docker-hub-username }}/${{ inputs.project-name }}-${{ inputs.application-name }}/tags/$TAG/"
                echo "  Deleted: $TAG"
                sleep 1
              fi
            done
          else
            echo "‚úÖ No old tags to delete"
          fi
